# Activity Streaks Implementation Guide

## Overview

This document describes the implementation of two new automatically tracked activity streaks in The Tribe application:

1. **Daily Engagement Streak**: Tracks consecutive days the user logs in or visits the site while authenticated
2. **Daily Check-In Streak**: Tracks consecutive days the user completes their MEPSS Check-In

## Architecture

The implementation follows a three-tier architecture:

### 1. Database Layer (Supabase)
- **Table**: `daily_user_activity` - Stores daily activity records
- **RPC Functions**: Three functions for recording and calculating streaks
- **Row Level Security**: Ensures users can only access their own data

### 2. Backend Logic (Supabase Functions)
- `record_user_activity()` - Marks user as active for the day
- `record_check_in_activity()` - Marks check-in completion for the day
- `get_user_streaks()` - Calculates both streaks using consecutive day logic

### 3. Frontend (React/TypeScript)
- **Custom Hook**: `useUserStreaks` - Manages streak state and API calls
- **Component**: `StreakBadge` - Reusable UI component for displaying streaks
- **Dashboard Integration**: New KPI cards replacing "Weekly Average" and "Community"

---

## Database Schema

### Table: `daily_user_activity`

```sql
CREATE TABLE public.daily_user_activity (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  activity_date DATE NOT NULL DEFAULT CURRENT_DATE,
  was_active BOOLEAN NOT NULL DEFAULT FALSE,
  completed_check_in BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (user_id, activity_date)
);
```

**Key Features:**
- One record per user per day (enforced by UNIQUE constraint)
- Boolean flags for different activity types
- Automatic timestamps for audit trail
- Cascade delete when user is removed

**Indexes:**
- `idx_daily_user_activity_user_id` - Fast user lookups
- `idx_daily_user_activity_date` - Date-based queries
- `idx_daily_user_activity_user_date` - Combined user+date queries

**Row Level Security:**
- Policy: "Allow users to manage their own activity"
- Users can only SELECT/INSERT/UPDATE/DELETE their own records
- Enforced via `auth.uid() = user_id`

---

## Backend Functions

### 1. `record_user_activity()`

**Purpose**: Mark user as active for the current day

**When Called**: Automatically when the app loads (via `useEffect` in `App.tsx`)

**Logic**:
```sql
INSERT INTO daily_user_activity (user_id, activity_date, was_active)
VALUES (auth.uid(), CURRENT_DATE, TRUE)
ON CONFLICT (user_id, activity_date)
DO UPDATE SET was_active = TRUE, updated_at = NOW();
```

**Behavior**:
- Creates new record if none exists for today
- Updates existing record if already present (idempotent)
- Uses UPSERT pattern for safety

---

### 2. `record_check_in_activity()`

**Purpose**: Mark that user completed their MEPSS check-in for the current day

**When Called**: After successful check-in submission (in `DailyCheckin.tsx`)

**Logic**:
```sql
INSERT INTO daily_user_activity (user_id, activity_date, completed_check_in)
VALUES (auth.uid(), CURRENT_DATE, TRUE)
ON CONFLICT (user_id, activity_date)
DO UPDATE SET completed_check_in = TRUE, updated_at = NOW();
```

**Behavior**:
- Creates new record if none exists for today
- Updates existing record if already present
- Independent of `was_active` flag

---

### 3. `get_user_streaks()`

**Purpose**: Calculate both engagement and check-in streaks for the current user

**Returns**: JSON object
```json
{
  "engagement_streak": 15,
  "check_in_streak": 8
}
```

**Algorithm**:
1. Start from today's date
2. For each streak type:
   - Check if activity flag is TRUE for current date
   - If FALSE or no record, break the streak
   - If TRUE, increment counter and check previous day
   - Repeat until streak breaks
3. Return both streak counts as JSON

**Performance**: O(n) where n is the streak length (typically small)

---

## Frontend Implementation

### Custom Hook: `useUserStreaks`

**Location**: `src/hooks/useUserStreaks.ts`

**API**:
```typescript
const {
  streaks,           // { engagement_streak: number, check_in_streak: number }
  isLoading,         // boolean
  error,             // string | null
  refetch,           // () => Promise<void>
  recordActivity,    // () => Promise<void>
  recordCheckIn,     // () => Promise<void>
} = useUserStreaks();
```

**Features**:
- Automatic fetching on mount
- Optimistic updates after recording activities
- Error handling with fallback to zero streaks
- Memoized callbacks to prevent unnecessary re-renders

**Usage Example**:
```typescript
const { streaks, recordActivity } = useUserStreaks();

useEffect(() => {
  if (user) {
    recordActivity(); // Record engagement on app load
  }
}, [user, recordActivity]);
```

---

### Component: `StreakBadge`

**Location**: `src/components/StreakBadge.tsx`

**Props**:
```typescript
interface StreakBadgeProps {
  icon: LucideIcon;      // Icon component (e.g., Flame, CheckCircle)
  streakCount: number;   // Number of consecutive days
  label: string;         // Label text (e.g., "Daily Visits")
  color?: 'green' | 'blue' | 'purple' | 'orange';
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}
```

**Features**:
- Framer Motion animations (scale on hover)
- Responsive sizing (sm, md, lg)
- Color variants matching app theme
- Accessible with title attribute
- Tabular numbers for consistent width

**Usage Example**:
```tsx
<StreakBadge
  icon={Flame}
  streakCount={15}
  label="Daily Visits"
  color="orange"
  size="md"
/>
```

---

## Dashboard Integration

### Changes Made

**Removed**:
- "Weekly Average" KPI card (average MEPSS score)
- "Active Community" KPI card

**Added**:
- **Engagement Streak Card**: Orange gradient with Flame icon
- **Check-In Streak Card**: Teal gradient with CheckCircle icon

**Visual Design**:
- Matches existing KPI card style (rounded-2xl, shadow-lg, hover effects)
- Unique gradient colors to distinguish from other cards
- Loading state with "..." placeholder
- Responsive text sizing
- Proper pluralization ("1 day" vs "2 days")

**Card Order** (left to right):
1. Days Sober (purple)
2. Today's Check-in Status (green/yellow)
3. Engagement Streak (orange)
4. Check-In Streak (teal)

---

## Testing Checklist

### Database Testing
- [ ] Verify table creation in Supabase dashboard
- [ ] Test RLS policies (users can only see their own data)
- [ ] Verify indexes are created
- [ ] Test UPSERT behavior (multiple calls on same day)

### Backend Function Testing
- [ ] Call `record_user_activity()` multiple times - should be idempotent
- [ ] Call `record_check_in_activity()` after check-in submission
- [ ] Verify `get_user_streaks()` returns correct counts
- [ ] Test streak calculation with gaps in activity
- [ ] Test with brand new user (no activity records)

### Frontend Testing
- [ ] Verify engagement streak increments on daily visits
- [ ] Verify check-in streak increments after completing check-in
- [ ] Test loading states on Dashboard
- [ ] Verify streaks display correctly (0, 1, 2+)
- [ ] Test error handling (network failures)
- [ ] Verify proper pluralization ("day" vs "days")
- [ ] Test responsive design on mobile/tablet/desktop

### Integration Testing
- [ ] Complete a check-in and verify both streaks update
- [ ] Visit app on consecutive days and verify engagement streak
- [ ] Skip a day and verify streak resets to 0
- [ ] Test with multiple users (no data leakage)

---

## Migration Files

1. **`supabase/migrations/20250107000001_create_daily_user_activity.sql`**
   - Creates `daily_user_activity` table
   - Sets up indexes and RLS policies

2. **`supabase/migrations/20250107000002_create_activity_functions.sql`**
   - Creates three RPC functions
   - Grants execute permissions to authenticated users

**To Apply Migrations**:
```bash
# Using Supabase CLI
supabase db push

# Or apply manually via Supabase Dashboard > SQL Editor
```

---

## Future Enhancements

### Potential Features
1. **Streak Milestones**: Celebrate 7, 30, 100, 365 day streaks with confetti
2. **Streak Recovery**: Allow one "grace day" to maintain streak
3. **Leaderboards**: Show top streaks in community (opt-in)
4. **Streak Insights**: Analytics showing streak patterns over time
5. **Push Notifications**: Remind users to maintain their streak
6. **Streak Badges**: Award badges for milestone achievements
7. **Historical Streaks**: Track longest streak ever achieved

### Performance Optimizations
1. **Caching**: Cache streak data in localStorage with TTL
2. **Batch Updates**: Combine multiple activity recordings
3. **Materialized Views**: Pre-calculate streaks for faster queries
4. **Pagination**: For users with very long streaks

---

## Troubleshooting

### Streaks Not Updating
- Check browser console for API errors
- Verify RPC functions exist in Supabase
- Confirm user is authenticated
- Check RLS policies are correctly configured

### Incorrect Streak Counts
- Verify timezone handling (all dates use CURRENT_DATE)
- Check for gaps in `daily_user_activity` table
- Ensure `was_active` and `completed_check_in` flags are set correctly

### Performance Issues
- Check database indexes are created
- Monitor query execution time in Supabase logs
- Consider adding caching for frequently accessed data

---

## Conclusion

This implementation provides a robust, scalable foundation for tracking user engagement and check-in streaks. The three-tier architecture ensures separation of concerns, while the automatic tracking reduces user friction and encourages consistent engagement with the platform.

The system is designed to be:
- **Reliable**: UPSERT operations prevent duplicates
- **Secure**: RLS ensures data privacy
- **Performant**: Indexed queries and efficient algorithms
- **Maintainable**: Clear separation of concerns
- **Extensible**: Easy to add new activity types

For questions or issues, refer to the codebase or contact the development team.

